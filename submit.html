<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>繳交 Flag</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
</head>

<body class="flag-page">
  <div class="bg-layers" aria-hidden="true">
    <div class="stars" id="starHost"></div>
    <div class="waves" aria-hidden="true">
      <div class="wave-layer layer1"></div>
      <div class="wave-layer layer2"></div>
      <div class="wave-layer layer3"></div>
    </div>
  </div>

  <main class="content-shell" role="main">
    <div class="page-header">
      <h1 class="page-title"><i class="bi bi-flag-fill page-icon"></i> 繳交 Flag</h1>
      <p class="page-subtitle">輸入學號上繳 Flag 並查看排行榜。</p>
    </div>

    <div class="flagset-grid">
      <div class="left-col">
        <section class="cardx">
          <div class="cardx-header">
            <h3 class="cardx-title"><i class="bi bi-upload me-2"></i>上繳 Flag</h3>
            <p class="cardx-subtitle">填寫資訊後送出（會呼叫 /api/submit）</p>
          </div>

          <div class="cardx-body">
            <form id="submit-form" autocomplete="off">
              <div class="form-grid">
                <div class="field">
                  <label class="field-label" for="name">姓名</label>
                  <input class="inputx" type="text" id="name" name="name" placeholder="輸入姓名" required maxlength="30">
                </div>
                <div class="field">
                  <label class="field-label" for="studentId">學號</label>
                  <input class="inputx" type="text" id="studentId" name="studentId" placeholder="輸入學號" required maxlength="20">
                </div>
                <div class="field field-full">
                  <label class="field-label" for="flag">Flag</label>
                  <input class="inputx" type="text" id="flag" name="flag" placeholder="FLAG{...}" required maxlength="200">
                </div>
              </div>
              <div class="actions">
                <button type="submit" class="btnx primary"><i class="bi bi-send-fill me-1"></i>送出</button>
                <button type="button" class="btnx ghost" id="btn-refresh"><i class="bi bi-arrow-clockwise me-1"></i>刷新排行榜</button>
              </div>
              <div id="status" class="statusx" aria-live="polite"></div>
              <small class="form-hint">提示：送出成功後，右側排行榜會自動更新。</small>
            </form>
          </div>
        </section>
      </div>

      <div class="right-col">
        <section class="cardx rank-card">
          <div class="cardx-header with-action">
            <div>
              <h6 class="cardx-title"><i class="bi bi-trophy-fill me-2"></i>總排行榜（依繳交數排序）</h6>
              <p class="cardx-subtitle">依繳交次數與最早提交時間排序</p>
            </div>
          </div>
          <div class="cardx-body compact">
            <ol class="rank-list compact" id="rank-overall"></ol>
          </div>
        </section>

        <!-- 完整榜單（如果你原本就有 Modal / 區塊，用這個 id 就能渲染） -->
        <div style="display:none">
          <ol class="rank-list" id="rank-overall-full"></ol>
        </div>
      </div>
    </div>
  </main>

  <script>
  // ======= 工具 =======
  function escapeHtml(str) {
    return String(str ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function unwrapData(json) {
    if (!json || typeof json !== 'object') return [];
    if (json.ok && Array.isArray(json.data)) return json.data;
    return [];
  }

  // ✅ 改這裡：排行榜顯示「FLAG數」＋「最早提交」＋ 正確排序
  function renderRankList(listEl, data, limit = 10) {
    listEl.innerHTML = '';
    if (!Array.isArray(data) || data.length === 0) {
      listEl.innerHTML = '<li class="rank-empty">目前沒有資料</li>';
      return;
    }

    data.slice(0, limit).forEach((e, i) => {
      const rank = i + 1;
      const topClass = rank === 1 ? 'top1' : rank === 2 ? 'top2' : rank === 3 ? 'top3' : '';
      const name = escapeHtml(e.name || '');
      const sid  = escapeHtml(e.studentId || '');
      const cnt  = Number(e.flagCount ?? e.count ?? 0);
      const firstTime = escapeHtml(e.firstTime || e.time || '');

      listEl.insertAdjacentHTML('beforeend', `
        <li class="rank-item ${topClass}">
          <div class="rank-num">${rank}</div>
          <div class="rank-main">
            <div class="rank-line">
              <span class="rank-name">${name}</span>
              <span class="rank-id">${sid}</span>
              <span class="rank-pill"><i class="bi bi-flag-fill"></i> ${cnt}</span>
              <span class="rank-pill"><i class="bi bi-clock-history"></i> ${firstTime}</span>
            </div>
          </div>
        </li>
      `);
    });
  }

  async function loadLeaderboard() {
    const overallTopEl  = document.getElementById('rank-overall');
    const overallFullEl = document.getElementById('rank-overall-full');

    try {
      const res = await fetch('/api/leaderboard', { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);

      const json = await res.json();
      const data = unwrapData(json);

      // ✅ 排名規則：繳交數量越多越前；同數量時，越早提交越前
      data.sort((a, b) => {
        const cntA = Number(a.flagCount ?? a.count ?? 0);
        const cntB = Number(b.flagCount ?? b.count ?? 0);
        if (cntA !== cntB) return cntB - cntA;

        const tA = String(a.firstTime || a.time || '');
        const tB = String(b.firstTime || b.time || '');
        return tA.localeCompare(tB); // 越早越小
      });

      renderRankList(overallTopEl,  data, 10);
      if (overallFullEl) renderRankList(overallFullEl, data, 999);
      return;
    } catch (err) {
      console.warn('loadLeaderboard failed, using demo data:', err);

      // Demo / fallback
      const demoData = [
        { studentId: 'C111151142', name: '謝金佑', flagCount: 1, firstTime: '2025-12-18 21:06:21' },
        { studentId: 'C111151143', name: '王小明', flagCount: 1, firstTime: '2025-12-18 21:10:12' },
      ];
      renderRankList(overallTopEl,  demoData, 10);
      if (overallFullEl) renderRankList(overallFullEl, demoData, 999);
    }
  }

  async function handleSubmit(event) {
    event.preventDefault();
    const name = document.getElementById('name').value.trim();
    const studentId = document.getElementById('studentId').value.trim();
    const flag = document.getElementById('flag').value.trim();

    try {
      const res = await fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, studentId, flag })
      });

      const json = await res.json().catch(() => ({}));
      const msg = json.message || '提交完成';

      const statusEl = document.getElementById('status');
      statusEl.textContent = msg;
      statusEl.className = (json.ok ? 'statusx success' : 'statusx error');

      await loadLeaderboard();
    } catch (err) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = '提交失敗';
      statusEl.className = 'statusx error';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('submit-form').addEventListener('submit', handleSubmit);
    document.getElementById('btn-refresh').addEventListener('click', loadLeaderboard);
    loadLeaderboard();
  });
  </script>
</body>
</html>
