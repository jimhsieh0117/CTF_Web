<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <title>繳交 Flag | 沉睡的秘密</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css">
  <!-- Note: Removing bootstrap, using custom styles -->
</head>

<body class="submit-page">
  <!-- Modal Overlay -->
  <div id="ctf-modal-overlay">
    <div class="ctf-modal">
      <button class="ctf-modal-close">×</button>
      <h3 class="ctf-modal-title" id="modal-title">標題</h3>
      <div class="ctf-modal-body" id="modal-body">內容...</div>
    </div>
  </div>

  <div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">解除封印中...</div>
  </div>

  <main id="submit-stage">
    <div class="content-card">

      <h1>繳交 Flag</h1>
      <p class="secret-hint" style="margin-bottom: 2rem;">上繳學號與真相，揭開下一層的迷霧。</p>

      <div class="page-grid">
        <!-- Left Column: Submit & Story -->
        <div class="left-col">

          <!-- Submit Form -->
          <section class="inner-card">
            <div class="card-title">上繳 Flag</div>
            <form id="submit-form" autocomplete="off">
              <div class="form-group">
                <label for="studentId">學號</label>
                <input type="text" id="studentId" name="studentId" placeholder="CXXXXXXXXX" required maxlength="10"
                  pattern="^C\d{9}$" autocomplete="off">
                <small class="error-msg" id="studentId-error" style="display:none"></small>
              </div>

              <div class="form-group" style="text-align: right;">
                <button type="button" class="btn btn-secondary" id="btn-query-story"
                  style="padding: 0.5rem 1rem; font-size: 0.9rem;">查詢進度</button>
              </div>

              <div class="form-group">
                <label for="flag">Flag</label>
                <input type="text" id="flag" name="flag" placeholder="FLAG{...}" required maxlength="200">
              </div>

              <div class="form-group" style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                <button type="submit" class="btn">送出</button>
                <button type="button" class="btn btn-secondary" id="btn-refresh">刷新榜單</button>
                <a href="index.html" class="btn btn-secondary" style="margin-left: auto;">返回首頁</a>
              </div>

              <div id="status" class="status-box"></div>
            </form>
          </section>

          <!-- Story Section -->
          <section class="inner-card" id="story-card" style="display:none">
            <div class="card-title">劇情解鎖</div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
              <button type="button" class="btn btn-secondary" id="btn-story-ch1" disabled>第一章</button>
              <button type="button" class="btn btn-secondary" id="btn-story-ch2" disabled>第二章</button>
              <button type="button" class="btn btn-secondary" id="btn-story-ch3" disabled>第三章</button>
              <button type="button" class="btn btn-secondary" id="btn-story-ep" disabled>尾聲</button>
            </div>
            <small class="form-hint" id="story-status">請先輸入學號以載入解鎖進度。</small>
          </section>

        </div>

        <!-- Right Column: Leaderboard -->
        <div class="right-col">
          <section class="inner-card">
            <div class="card-title">傳承榜單</div>
            <ol class="rank-list" id="rank-overall">
              <!-- Items injected by JS -->
              <li class="rank-item"><span class="rank-num">-</span> 載入中...</li>
            </ol>
          </section>

          <div style="display:none">
            <ol id="rank-overall-full"></ol>
          </div>
        </div>
      </div>

    </div>
  </main>



  <script src="dialog.js"></script>
  <script>
    // ======= 工具 =======
    function escapeHtml(str) {
      return String(str ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function unwrapData(json) {
      if (!json || typeof json !== 'object') return [];
      if (json.ok && Array.isArray(json.data)) return json.data;
      return [];
    }

    // ======= 劇情（第二章 / 第三章 / 尾聲） =======
    const LS_STUDENT_ID_KEY = 'ctf_studentId';
    let storyParts = null;
    let progressData = null;
    let hasQueried = false;

    function isValidStudentId(studentId) {
      return /^C\d{9}$/.test(String(studentId || '').trim());
    }

    function setStudentIdError(text) {
      const el = document.getElementById('studentId-error');
      if (!el) return;
      if (!text) {
        el.textContent = '';
        el.style.display = 'none';
        return;
      }
      el.textContent = text;
      el.style.display = 'block';
    }

    function setQueryButtonVisible(visible) {
      const btn = document.getElementById('btn-query-story');
      if (!btn) return;
      btn.style.display = visible ? 'inline-block' : 'none';
    }

    function updateStudentIdUi(studentId) {
      const sid = String(studentId || '').trim();
      if (!sid) {
        setStudentIdError('');
        setQueryButtonVisible(false);
        setStoryVisible(false);
        return;
      }
      if (!isValidStudentId(sid)) {
        setStudentIdError('學號格式不正確（需為 C 加上 9 碼數字）');
        setQueryButtonVisible(false);
        setStoryVisible(false);
        return;
      }
      setStudentIdError('');
      setQueryButtonVisible(true);
    }

    function setStoryVisible(visible) {
      const card = document.getElementById('story-card');
      if (!card) return;
      card.style.display = visible ? 'block' : 'none'; // Block for inner-card
      if (!visible) closeStoryModal();
    }

    function setStoryStatus(text) {
      const el = document.getElementById('story-status');
      if (el) el.textContent = text;
    }

    function setStoryButtonsEnabled() {
      const b1 = document.getElementById('btn-story-ch1');
      const b2 = document.getElementById('btn-story-ch2');
      const b3 = document.getElementById('btn-story-ch3');
      const be = document.getElementById('btn-story-ep');

      const solvedCount = Number(progressData?.solvedCount ?? 0);

      // 顯示規則（依需求）：
      // - 第一關尚未解開：顯示 第一章
      // - 解開第一關、第二章尚未解鎖：顯示 第一章 + 第二章
      // - 解開第一、二關、第三章尚未解鎖：顯示 第一章 + 第二章 + 第三章
      // - 全解開：在第三章後面出現 尾聲
      const showCh1 = true;
      const showCh2 = solvedCount >= 1;
      const showCh3 = solvedCount >= 2;
      const showEp = solvedCount >= 3;

      if (b1) {
        b1.style.display = showCh1 ? 'inline-block' : 'none';
        b1.disabled = !(storyParts && storyParts.ch1);
      }
      if (b2) {
        b2.style.display = showCh2 ? 'inline-block' : 'none';
        b2.disabled = !(storyParts && storyParts.ch2);
      }
      if (b3) {
        b3.style.display = showCh3 ? 'inline-block' : 'none';
        b3.disabled = !(storyParts && storyParts.ch3);
      }
      if (be) {
        be.style.display = showEp ? 'inline-block' : 'none';
        be.disabled = !(storyParts && storyParts.ep);
      }
    }

    async function loadStory() {
      try {
        const res = await fetch('/CTF_story.md', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const md = await res.text();
        storyParts = parseStoryMarkdown(md);
      } catch {
        storyParts = null;
        setStoryStatus('劇情載入失敗。');
      }
      setStoryButtonsEnabled();
    }

    async function refreshProgress(studentId, forceShow = false) {
      const sid = String(studentId || '').trim();
      if (!sid) {
        setStoryVisible(false);
        setStoryStatus('請先輸入學號，並按「查詢進度」。');
        return;
      }
      if (!isValidStudentId(sid)) {
        setStoryVisible(false);
        setStudentIdError('學號格式不正確');
        return;
      }
      if (!hasQueried && !forceShow) {
        setStoryVisible(false);
        setStoryStatus('請按「查詢進度」以載入。');
        return;
      }

      setStoryVisible(true);

      try {
        const res = await fetch('/api/progress', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ studentId: sid }),
        });
        const json = await res.json().catch(() => ({}));
        if (!res.ok || !json.ok) {
          progressData = null;
          setStoryStatus(json.message || '進度讀取失敗');
          setStoryButtonsEnabled();
          return;
        }
        progressData = json.data;
        const solved = Number(progressData?.solvedCount ?? 0);
        if (solved <= 0) setStoryStatus('劇情解鎖：第一章');
        else if (solved === 1) setStoryStatus('劇情解鎖：第一章、第二章');
        else if (solved === 2) setStoryStatus('劇情解鎖：第一章、第二章、第三章');
        else setStoryStatus('劇情解鎖：第一章、第二章、第三章、尾聲');
      } catch {
        progressData = null;
        setStoryStatus('進度讀取失敗');
      }
      setStoryButtonsEnabled();
    }

    function renderRankList(listEl, data, limit = 10) {
      listEl.innerHTML = '';
      if (!Array.isArray(data) || data.length === 0) {
        listEl.innerHTML = '<li class="rank-item" style="justify-content:center; opacity:0.5;">目前沒有資料</li>';
        return;
      }

      data.slice(0, limit).forEach((e, i) => {
        const rank = i + 1;
        const topClass = rank === 1 ? 'top1' : rank === 2 ? 'top2' : rank === 3 ? 'top3' : '';
        const sid = escapeHtml(e.studentId || '');
        const cnt = Number(e.flagCount ?? e.count ?? 0);
        const firstTime = escapeHtml(e.firstTime || e.time || '');

        listEl.insertAdjacentHTML('beforeend', `
        <li class="rank-item ${topClass}">
          <div class="rank-num">${rank}</div>
          <div class="rank-info">
              <span class="rank-name">${sid}</span>
              <div style="display:flex; gap: 12px; align-items: baseline;">
                  <span class="rank-score" style="color: var(--text-accent); font-weight:bold;">${cnt} Flags</span>
                  <span class="rank-time" style="font-size: 0.85em; opacity: 0.6;">${firstTime}</span>
              </div>
          </div>
        </li>
      `);
      });
    }

    async function loadLeaderboard() {
      const overallTopEl = document.getElementById('rank-overall');
      const overallFullEl = document.getElementById('rank-overall-full');

      try {
        const res = await fetch('/api/leaderboard', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        const data = unwrapData(json);

        data.sort((a, b) => {
          const cntA = Number(a.flagCount ?? a.count ?? 0);
          const cntB = Number(b.flagCount ?? b.count ?? 0);
          if (cntA !== cntB) return cntB - cntA;
          const tA = String(a.firstTime || a.time || '');
          const tB = String(b.firstTime || b.time || '');
          return tA.localeCompare(tB);
        });

        renderRankList(overallTopEl, data, 20); // Show more items in this vertical list
        if (overallFullEl) renderRankList(overallFullEl, data, 999);
      } catch (err) {
        if (overallTopEl) overallTopEl.innerHTML = '<li class="rank-item">排行榜暫時無法載入</li>';
      }
    }

    async function handleSubmit(event) {
      event.preventDefault();
      const studentId = document.getElementById('studentId').value.trim();
      const flag = document.getElementById('flag').value.trim();
      const statusEl = document.getElementById('status');
      const loadingEl = document.getElementById('loading-overlay');

      statusEl.style.display = 'none';
      if (loadingEl) loadingEl.classList.add('visible');

      try {
        // Intentional delay for effect (optional, keep it snappy but visible)
        // await new Promise(r => setTimeout(r, 800)); 

        const res = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ studentId, flag })
        });
        const json = await res.json().catch(() => ({}));
        const msg = json.message || '錯誤';

        statusEl.textContent = msg;
        statusEl.style.display = 'block';
        statusEl.className = (json.ok ? 'status-box success' : 'status-box error');

        await loadLeaderboard();

        if (json.ok) {
          // Refresh progress and check for story unlock
          // Force show story section since we just successfully submitted
          hasQueried = true;
          await refreshProgress(studentId, true);

          // Auto-trigger story dialog based on new solved count
          if (progressData && typeof progressData.solvedCount === 'number') {
            const count = progressData.solvedCount;
            // Check if we just unlocked something. logic:
            // If count == 1 => unlocked ch2.
            // If count == 2 => unlocked ch3.
            // If count == 3 => unlocked ep.
            // (This assumes linear progression 1->2->3)

            if (count === 1 && storyParts?.ch2) {
              openStoryModal(storyParts.ch2.title, storyParts.ch2.body);
            } else if (count === 2 && storyParts?.ch3) {
              openStoryModal(storyParts.ch3.title, storyParts.ch3.body);
            } else if (count >= 3 && storyParts?.ep) {
              openStoryModal(storyParts.ep.title, storyParts.ep.body);
            }
          }
        } else if (hasQueried) {
          // Even if failed, refresh progress just in case state changed elsewhere? 
          // Probably not needed but good for consistency if user changed ID manually
          await refreshProgress(studentId);
        }

      } catch (err) {
        statusEl.textContent = '提交失敗（網路錯誤）';
        statusEl.style.display = 'block';
        statusEl.className = 'status-box error';
      } finally {
        if (loadingEl) loadingEl.classList.remove('visible');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const studentIdEl = document.getElementById('studentId');
      const savedSid = localStorage.getItem(LS_STUDENT_ID_KEY);
      if (studentIdEl && savedSid) studentIdEl.value = savedSid;

      setStoryVisible(false);
      updateStudentIdUi(studentIdEl ? studentIdEl.value : '');

      document.getElementById('submit-form').addEventListener('submit', handleSubmit);
      document.getElementById('btn-refresh').addEventListener('click', loadLeaderboard);

      // Story buttons
      const bindBtn = (id, partKey) => {
        const btn = document.getElementById(id);
        if (btn) btn.addEventListener('click', () => {
          if (storyParts && storyParts[partKey]) {
            openStoryModal(storyParts[partKey].title, storyParts[partKey].body);
          }
        });
      };
      bindBtn('btn-story-ch1', 'ch1');
      bindBtn('btn-story-ch2', 'ch2');
      bindBtn('btn-story-ch3', 'ch3');
      bindBtn('btn-story-ep', 'ep');

      if (studentIdEl) {
        studentIdEl.addEventListener('input', () => {
          localStorage.setItem(LS_STUDENT_ID_KEY, studentIdEl.value.trim());
          hasQueried = false;
          setStoryVisible(false);
          setStoryStatus('請按「查詢進度」以載入。');
          updateStudentIdUi(studentIdEl.value);
        });
      }

      document.getElementById('btn-query-story').addEventListener('click', async () => {
        const sid = studentIdEl ? studentIdEl.value.trim() : '';
        if (!sid) return;
        localStorage.setItem(LS_STUDENT_ID_KEY, sid);
        hasQueried = true;
        await refreshProgress(sid);
      });

      loadLeaderboard();
      loadStory();
      if (savedSid) refreshProgress(savedSid);
    });
  </script>
</body>

</html>